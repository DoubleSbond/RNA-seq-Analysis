class BlastAnalysisPipeline:
    """
    ä¸»åˆ†æç®¡é“ - æ ¸å¿ƒæ€ç»´ï¼šå°†å„ä¸ªæ¨¡å—ä¸²è”æˆå®Œæ•´å·¥ä½œæµ
    """
    
    def __init__(self, blast_file_path):
        self.blast_file_path = blast_file_path
        self.raw_data = None
        self.filtered_data = None
        self.annotation_results = None
        self.analysis_report = {}
    
    def run_full_analysis(self, filter_thresholds=None, sample_nrows=None):
        """è¿è¡Œå®Œæ•´åˆ†æç®¡é“"""
        print("ğŸš€ å¯åŠ¨BLASTåˆ†æç®¡é“...")
        print("=" * 50)
        
        # æ­¥éª¤1: æ•°æ®åŠ è½½
        print("ğŸ“¥ æ­¥éª¤1: åŠ è½½BLASTæ•°æ®...")
        self.raw_data = BlastDataLoader.load_blast_data(
            self.blast_file_path, sample_nrows
        )
        
        # æ­¥éª¤2: è´¨é‡è¿‡æ»¤
        print("\nğŸ” æ­¥éª¤2: åº”ç”¨è´¨é‡è¿‡æ»¤...")
        filter_obj = QualityFilter(filter_thresholds)
        self.filtered_data = filter_obj.apply_filters(self.raw_data)
        self.analysis_report['filtering'] = filter_obj.create_filtering_report(
            self.raw_data, self.filtered_data
        )
        
        # æ­¥éª¤3: åŸºå› æ³¨é‡Š
        print("\nğŸ·ï¸  æ­¥éª¤3: åŸºå› å®¶æ—æ³¨é‡Š...")
        self.annotation_results = GeneAnnotator.annotate_genes(self.filtered_data)
        
        # æ­¥éª¤4: ä¸“é—¨åˆ†æï¼ˆå¦‚CYP450ï¼‰
        if 'CYP450' in self.annotation_results:
            print("\nğŸ”¬ æ­¥éª¤4: CYP450è¯¦ç»†åˆ†æ...")
            cyp_analysis = GeneAnnotator.detailed_cyp_analysis(
                self.annotation_results['CYP450']
            )
            self.analysis_report['cyp450'] = cyp_analysis
        
        # æ­¥éª¤5: å¯è§†åŒ–
        print("\nğŸ“Š æ­¥éª¤5: ç”Ÿæˆå¯è§†åŒ–...")
        fig = ResultVisualizer.plot_gene_family_distribution(self.annotation_results)
        
        print("\nâœ… åˆ†æå®Œæˆ!")
        return self.analysis_report
    
    def save_results(self, output_dir="results"):
        """ä¿å­˜åˆ†æç»“æœ"""
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # ä¿å­˜è¿‡æ»¤åçš„æ•°æ®
        if self.filtered_data is not None:
            self.filtered_data.to_csv(f"{output_dir}/filtered_blast_results.csv", index=False)
        
        # ä¿å­˜åˆ†ææŠ¥å‘Š
        import json
        with open(f"{output_dir}/analysis_report.json", 'w') as f:
            json.dump(self.analysis_report, f, indent=2)
        
        print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜åˆ° {output_dir} ç›®å½•")
