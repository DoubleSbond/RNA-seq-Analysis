class QualityFilter:
    """
    è´¨é‡è¿‡æ»¤æ¨¡å— - æ ¸å¿ƒæ€ç»´ï¼šçµæ´»å¯é…ç½®çš„è¿‡æ»¤æ ‡å‡†
    """
    
    # é»˜è®¤è¿‡æ»¤é˜ˆå€¼ - å¯è½»æ¾ä¿®æ”¹
    DEFAULT_THRESHOLDS = {
        'max_evalue': 1e-20,      # Eå€¼é˜ˆå€¼
        'min_identity': 40,       # æœ€å°ä¸€è‡´æ€§
        'min_alignment_length': 30,  # æœ€å°æ¯”å¯¹é•¿åº¦
    }
    
    def __init__(self, thresholds=None):
        # ä½¿ç”¨ç”¨æˆ·æä¾›çš„é˜ˆå€¼æˆ–é»˜è®¤å€¼
        self.thresholds = thresholds or self.DEFAULT_THRESHOLDS.copy()
    
    def apply_filters(self, df, verbose=True):
        """åº”ç”¨è´¨é‡è¿‡æ»¤"""
        original_count = len(df)
        
        # é€æ­¥åº”ç”¨è¿‡æ»¤æ¡ä»¶ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
        filtered_df = df.copy()
        
        # 1. Eå€¼è¿‡æ»¤
        pre_evalue = len(filtered_df)
        filtered_df = filtered_df[filtered_df['evalue'] < self.thresholds['max_evalue']]
        if verbose:
            print(f"  Eå€¼è¿‡æ»¤: {pre_evalue:,} â†’ {len(filtered_df):,} "
                  f"(ç§»é™¤ {pre_evalue - len(filtered_df):,})")
        
        # 2. ä¸€è‡´æ€§è¿‡æ»¤
        pre_identity = len(filtered_df)
        filtered_df = filtered_df[filtered_df['pident'] > self.thresholds['min_identity']]
        if verbose:
            print(f"  ä¸€è‡´æ€§è¿‡æ»¤: {pre_identity:,} â†’ {len(filtered_df):,} "
                  f"(ç§»é™¤ {pre_identity - len(filtered_df):,})")
        
        # 3. æ¯”å¯¹é•¿åº¦è¿‡æ»¤
        pre_length = len(filtered_df)
        filtered_df = filtered_df[filtered_df['length'] > self.thresholds['min_alignment_length']]
        if verbose:
            print(f"  é•¿åº¦è¿‡æ»¤: {pre_length:,} â†’ {len(filtered_df):,} "
                  f"(ç§»é™¤ {pre_length - len(filtered_df):,})")
        
        retention_rate = len(filtered_df) / original_count * 100
        if verbose:
            print(f"ğŸ“Š æ€»ä¿ç•™ç‡: {retention_rate:.1f}% "
                  f"({len(filtered_df):,}/{original_count:,})")
        
        return filtered_df
    
    def create_filtering_report(self, original_df, filtered_df):
        """ç”Ÿæˆè¿‡æ»¤æŠ¥å‘Š"""
        report = {
            'original_count': len(original_df),
            'filtered_count': len(filtered_df),
            'retention_rate': len(filtered_df) / len(original_df) * 100,
            'thresholds_used': self.thresholds,
            'average_identity_original': original_df['pident'].mean(),
            'average_identity_filtered': filtered_df['pident'].mean(),
            'median_evalue_original': original_df['evalue'].median(),
            'median_evalue_filtered': filtered_df['evalue'].median(),
        }
        return report
